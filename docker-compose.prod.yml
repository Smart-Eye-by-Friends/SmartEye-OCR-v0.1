# ============================================================================
# SmartEyeSsen - Production Docker Compose Configuration
# ============================================================================
# 4개 서비스: MySQL, Backend (FastAPI), Frontend (Nginx), Certbot (SSL)
# 사용법: docker compose -f docker-compose.prod.yml up -d

version: '3.8'

services:
  # ==========================================================================
  # MySQL Database (8.0)
  # ==========================================================================
  mysql:
    image: mysql:8.0
    container_name: smarteyessen_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-change_this_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-smarteyessen_db}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      # 초기화 스크립트 (선택적)
      # - ./Backend/scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-change_this_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - smarteyessen_network

  # ==========================================================================
  # Backend (FastAPI + Python 3.9)
  # ==========================================================================
  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    container_name: smarteyessen_backend
    restart: unless-stopped
    env_file:
      - Backend/.env
    environment:
      # Override .env for Docker network
      DB_HOST: mysql
      DB_PORT: 3306
      ENVIRONMENT: production
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      # 업로드 파일 영속성 (호스트와 공유)
      - ./Backend/uploads:/app/uploads
      - ./Backend/static:/app/static
      # 로그 (선택적)
      # - ./Backend/logs:/app/logs
    networks:
      - smarteyessen_network
    # 포트 노출 (디버깅용, 프로덕션에서는 주석 처리 권장)
    # ports:
    #   - "8000:8000"

  # ==========================================================================
  # Frontend (Nginx + React)
  # ==========================================================================
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
      args:
        # Reverse Proxy 사용으로 상대 경로
        VITE_API_BASE_URL: /api
    container_name: smarteyessen_frontend
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
    volumes:
      # SSL 인증서 (Let's Encrypt)
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      # Nginx 설정 변경 시 재시작 없이 반영 (선택적)
      # - ./Frontend/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - smarteyessen_network
    # Nginx 설정 리로드 (선택적)
    # command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"

  # ==========================================================================
  # Certbot (Let's Encrypt SSL 자동 갱신)
  # ==========================================================================
  certbot:
    image: certbot/certbot
    container_name: smarteyessen_certbot
    restart: unless-stopped
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    # 12시간마다 인증서 갱신 체크
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot --webroot-path=/var/www/certbot; sleep 12h & wait $${!}; done;'"
    networks:
      - smarteyessen_network

# ============================================================================
# Volumes (데이터 영속성)
# ============================================================================
volumes:
  mysql_data:
    driver: local

# ============================================================================
# Networks (컨테이너 간 통신)
# ============================================================================
networks:
  smarteyessen_network:
    driver: bridge
