<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartEye ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        .metric-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .metric-icon {
            margin-right: 10px;
            font-size: 1.4em;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        .metric-description {
            color: #666;
            font-size: 0.9em;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-critical { background-color: #dc3545; }
        .refresh-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
        }
        .refresh-button:hover {
            background: #5a6fd8;
        }
        .last-updated {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-size: 0.9em;
        }
        .alert-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .alert-panel.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .log-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” SmartEye ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ì‹¤ì‹œê°„ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë° ì‹œìŠ¤í…œ ìƒíƒœ ëª¨ë‹ˆí„°ë§</p>
        <button class="refresh-button" onclick="refreshAllMetrics()">ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
        <button class="refresh-button" onclick="toggleAutoRefresh()">â±ï¸ ìë™ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <!-- ì•Œë¦¼ íŒ¨ë„ -->
    <div id="alertPanel" style="display: none;"></div>

    <div class="dashboard-container">
        <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
        <div class="metric-card">
            <div class="metric-title">
                <span class="metric-icon">âš¡</span>
                ì‹œìŠ¤í…œ ìƒíƒœ
            </div>
            <div class="metric-value" id="systemStatus">
                <span class="status-indicator status-healthy"></span>ì •ìƒ
            </div>
            <div class="metric-description">
                ë§ˆì§€ë§‰ í™•ì¸: <span id="lastHealthCheck">-</span>
            </div>
        </div>

        <!-- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ -->
        <div class="metric-card">
            <div class="metric-title">
                <span class="metric-icon">ğŸ’¾</span>
                ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
            </div>
            <div class="metric-value" id="memoryUsage">-</div>
            <div class="metric-description">
                ì‚¬ìš© ê°€ëŠ¥: <span id="memoryAvailable">-</span> / 
                ì „ì²´: <span id="memoryTotal">-</span>
            </div>
            <div class="chart-container">
                <canvas id="memoryChart"></canvas>
            </div>
        </div>

        <!-- API ì‘ë‹µ ì‹œê°„ -->
        <div class="metric-card">
            <div class="metric-title">
                <span class="metric-icon">â±ï¸</span>
                API ì‘ë‹µ ì‹œê°„
            </div>
            <div class="metric-value" id="avgResponseTime">-</div>
            <div class="metric-description">
                í‰ê·  ì‘ë‹µ ì‹œê°„ (ìµœê·¼ 1ì‹œê°„)
            </div>
            <div class="chart-container">
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>

        <!-- ì²˜ë¦¬ ì¤‘ì¸ ì‘ì—… -->
        <div class="metric-card">
            <div class="metric-title">
                <span class="metric-icon">ğŸ“Š</span>
                í™œì„± ì‘ì—…
            </div>
            <div class="metric-value" id="activeJobs">-</div>
            <div class="metric-description">
                ëŒ€ê¸°: <span id="pendingJobs">-</span> / 
                ì²˜ë¦¬ì¤‘: <span id="processingJobs">-</span> / 
                ì™„ë£Œ: <span id="completedJobs">-</span>
            </div>
        </div>

        <!-- ìºì‹œ ì„±ëŠ¥ -->
        <div class="metric-card">
            <div class="metric-title">
                <span class="metric-icon">ğŸš€</span>
                ìºì‹œ ì„±ëŠ¥
            </div>
            <div class="metric-value" id="cacheHitRate">-</div>
            <div class="metric-description">
                íˆíŠ¸: <span id="cacheHits">-</span> / 
                ë¯¸ìŠ¤: <span id="cacheMisses">-</span>
            </div>
            <div class="chart-container">
                <canvas id="cacheChart"></canvas>
            </div>
        </div>

        <!-- ì—ëŸ¬ í†µê³„ -->
        <div class="metric-card">
            <div class="metric-title">
                <span class="metric-icon">âš ï¸</span>
                ì—ëŸ¬ í†µê³„
            </div>
            <div class="metric-value" id="errorRate">-</div>
            <div class="metric-description">
                ìµœê·¼ 24ì‹œê°„ ì—ëŸ¬ìœ¨
            </div>
            <div class="chart-container">
                <canvas id="errorChart"></canvas>
            </div>
        </div>

        <!-- í™œì„± ì•Œë¦¼ -->
        <div class="metric-card" style="grid-column: 1 / -1;">
            <div class="metric-title">
                <span class="metric-icon">ğŸš¨</span>
                í™œì„± ì•Œë¦¼
                <button class="refresh-button" style="margin-left: auto; padding: 5px 10px; font-size: 0.8em;" onclick="refreshAlerts()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="activeAlerts">
                ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>

        <!-- ìµœê·¼ ë¡œê·¸ -->
        <div class="metric-card" style="grid-column: 1 / -1;">
            <div class="metric-title">
                <span class="metric-icon">ğŸ“</span>
                ìµœê·¼ ë¡œê·¸
                <button class="refresh-button" style="margin-left: auto; padding: 5px 10px; font-size: 0.8em;" onclick="refreshLogs()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="log-panel" id="recentLogs">
                ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>
    </div>

    <div class="last-updated">
        ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdated">-</span>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let charts = {};

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initCharts() {
            // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì°¨íŠ¸
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            charts.memory = new Chart(memoryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  (%)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // ì‘ë‹µ ì‹œê°„ ì°¨íŠ¸
            const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
            charts.responseTime = new Chart(responseCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì‘ë‹µ ì‹œê°„ (ms)',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // ìºì‹œ ì„±ëŠ¥ ì°¨íŠ¸
            const cacheCtx = document.getElementById('cacheChart').getContext('2d');
            charts.cache = new Chart(cacheCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ìºì‹œ íˆíŠ¸', 'ìºì‹œ ë¯¸ìŠ¤'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // ì—ëŸ¬ ì°¨íŠ¸
            const errorCtx = document.getElementById('errorChart').getContext('2d');
            charts.error = new Chart(errorCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì—ëŸ¬ ìˆ˜',
                        data: [],
                        backgroundColor: '#dc3545'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // API í˜¸ì¶œ í•¨ìˆ˜
        async function fetchMetrics() {
            try {
                const response = await fetch('/api/v1/monitoring/metrics/');
                if (!response.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜');
                return await response.json();
            } catch (error) {
                showAlert('ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                return null;
            }
        }

        // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        async function updateMetrics() {
            const metrics = await fetchMetrics();
            if (!metrics) return;

            // ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
            const statusElement = document.getElementById('systemStatus');
            const healthStatus = metrics.system_health || 'unknown';
            let statusClass = 'status-healthy';
            let statusText = 'ì •ìƒ';

            if (healthStatus === 'warning') {
                statusClass = 'status-warning';
                statusText = 'ì£¼ì˜';
            } else if (healthStatus === 'critical') {
                statusClass = 'status-critical';
                statusText = 'ìœ„í—˜';
            }

            statusElement.innerHTML = `<span class="status-indicator ${statusClass}"></span>${statusText}`;
            document.getElementById('lastHealthCheck').textContent = new Date().toLocaleTimeString();

            // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸
            if (metrics.memory) {
                document.getElementById('memoryUsage').textContent = metrics.memory.percent + '%';
                document.getElementById('memoryAvailable').textContent = formatBytes(metrics.memory.available);
                document.getElementById('memoryTotal').textContent = formatBytes(metrics.memory.total);

                // ë©”ëª¨ë¦¬ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                updateChart(charts.memory, new Date().toLocaleTimeString(), metrics.memory.percent);
            }

            // API ì‘ë‹µ ì‹œê°„ ì—…ë°ì´íŠ¸
            if (metrics.api_performance) {
                document.getElementById('avgResponseTime').textContent = metrics.api_performance.avg_response_time + 'ms';
                updateChart(charts.responseTime, new Date().toLocaleTimeString(), metrics.api_performance.avg_response_time);
            }

            // í™œì„± ì‘ì—… ì—…ë°ì´íŠ¸
            if (metrics.jobs) {
                document.getElementById('activeJobs').textContent = metrics.jobs.active;
                document.getElementById('pendingJobs').textContent = metrics.jobs.pending;
                document.getElementById('processingJobs').textContent = metrics.jobs.processing;
                document.getElementById('completedJobs').textContent = metrics.jobs.completed;
            }

            // ìºì‹œ ì„±ëŠ¥ ì—…ë°ì´íŠ¸
            if (metrics.cache) {
                const hitRate = (metrics.cache.hits / (metrics.cache.hits + metrics.cache.misses) * 100).toFixed(1);
                document.getElementById('cacheHitRate').textContent = hitRate + '%';
                document.getElementById('cacheHits').textContent = metrics.cache.hits;
                document.getElementById('cacheMisses').textContent = metrics.cache.misses;

                // ìºì‹œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                charts.cache.data.datasets[0].data = [metrics.cache.hits, metrics.cache.misses];
                charts.cache.update();
            }

            // ì—ëŸ¬ í†µê³„ ì—…ë°ì´íŠ¸
            if (metrics.errors) {
                document.getElementById('errorRate').textContent = metrics.errors.rate + '%';
                
                // ì—ëŸ¬ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ì‹œê°„ë³„ ì—ëŸ¬ ìˆ˜)
                if (metrics.errors.hourly) {
                    charts.error.data.labels = metrics.errors.hourly.map(item => item.hour);
                    charts.error.data.datasets[0].data = metrics.errors.hourly.map(item => item.count);
                    charts.error.update();
                }
            }

            // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

            // ì„ê³„ê°’ í™•ì¸ ë° ì•Œë¦¼
            checkThresholds(metrics);
        }

        // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateChart(chart, label, value) {
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(value);

            // ìµœëŒ€ 20ê°œ ë°ì´í„° í¬ì¸íŠ¸ ìœ ì§€
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.update();
        }

        // ì„ê³„ê°’ í™•ì¸
        function checkThresholds(metrics) {
            const alerts = [];

            if (metrics.memory && metrics.memory.percent > 85) {
                alerts.push(`ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë†’ìŠµë‹ˆë‹¤: ${metrics.memory.percent}%`);
            }

            if (metrics.api_performance && metrics.api_performance.avg_response_time > 5000) {
                alerts.push(`API ì‘ë‹µ ì‹œê°„ì´ ëŠë¦½ë‹ˆë‹¤: ${metrics.api_performance.avg_response_time}ms`);
            }

            if (metrics.errors && metrics.errors.rate > 5) {
                alerts.push(`ì—ëŸ¬ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤: ${metrics.errors.rate}%`);
            }

            if (alerts.length > 0) {
                showAlert(alerts.join('<br>'), 'warning');
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'warning') {
            const alertPanel = document.getElementById('alertPanel');
            alertPanel.className = `alert-panel ${type}`;
            alertPanel.innerHTML = `
                <strong>${type === 'error' ? 'âŒ ì˜¤ë¥˜' : 'âš ï¸ ê²½ê³ '}:</strong> ${message}
                <button style="float: right; background: none; border: none; font-size: 1.2em; cursor: pointer;" onclick="hideAlert()">Ã—</button>
            `;
            alertPanel.style.display = 'block';

            // 10ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            setTimeout(hideAlert, 10000);
        }

        function hideAlert() {
            document.getElementById('alertPanel').style.display = 'none';
        }

        // ì•Œë¦¼ ìƒˆë¡œê³ ì¹¨
        async function refreshAlerts() {
            try {
                const response = await fetch('/api/v1/monitoring/alerts/');
                if (!response.ok) throw new Error('ì•Œë¦¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
                
                const alertData = await response.json();
                const alertsPanel = document.getElementById('activeAlerts');
                
                if (alertData.active_alerts.length === 0) {
                    alertsPanel.innerHTML = '<div style="color: #28a745; padding: 10px; text-align: center;">âœ… í™œì„± ì•Œë¦¼ ì—†ìŒ</div>';
                } else {
                    alertsPanel.innerHTML = alertData.active_alerts.map(alert => {
                        const levelColor = alert.level === 'critical' ? '#dc3545' : '#ffc107';
                        const levelIcon = alert.level === 'critical' ? 'ğŸš¨' : 'âš ï¸';
                        
                        return `
                            <div style="border-left: 4px solid ${levelColor}; padding: 10px; margin: 5px 0; background: #f8f9fa;">
                                <div style="font-weight: bold; color: ${levelColor};">
                                    ${levelIcon} ${alert.title}
                                </div>
                                <div style="font-size: 0.9em; margin-top: 5px;">
                                    ${alert.message}
                                </div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                                    ${new Date(alert.timestamp).toLocaleString()}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // ì•Œë¦¼ í†µê³„ ì—…ë°ì´íŠ¸
                if (alertData.alert_statistics) {
                    const stats = alertData.alert_statistics;
                    // í˜ì´ì§€ ìƒë‹¨ì— ì•Œë¦¼ í†µê³„ í‘œì‹œ (í•„ìš”ì‹œ)
                    if (stats.active_alerts > 0) {
                        showAlert(`í˜„ì¬ ${stats.active_alerts}ê°œì˜ í™œì„± ì•Œë¦¼ì´ ìˆìŠµë‹ˆë‹¤.`, 'warning');
                    }
                }
                
            } catch (error) {
                document.getElementById('activeAlerts').innerHTML = 
                    '<div style="color: #dc3545;">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message + '</div>';
            }
        }

        // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
        async function refreshLogs() {
            try {
                const response = await fetch('/api/v1/monitoring/logs/recent/');
                if (!response.ok) throw new Error('ë¡œê·¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
                
                const logs = await response.json();
                const logPanel = document.getElementById('recentLogs');
                
                if (logs.length === 0) {
                    logPanel.textContent = 'ìµœê·¼ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                } else {
                    logPanel.innerHTML = logs.map(log => 
                        `<div>[${log.timestamp}] [${log.level}] ${log.message}</div>`
                    ).join('');
                }
            } catch (error) {
                document.getElementById('recentLogs').textContent = 'ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message;
            }
        }

        // ì „ì²´ ìƒˆë¡œê³ ì¹¨
        function refreshAllMetrics() {
            updateMetrics();
            refreshAlerts();
            refreshLogs();
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ í† ê¸€
        function toggleAutoRefresh() {
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                document.querySelector('button[onclick="toggleAutoRefresh()"]').textContent = 'â±ï¸ ìë™ ìƒˆë¡œê³ ì¹¨';
            } else {
                autoRefreshInterval = setInterval(refreshAllMetrics, 30000); // 30ì´ˆë§ˆë‹¤
                isAutoRefresh = true;
                document.querySelector('button[onclick="toggleAutoRefresh()"]').textContent = 'â¸ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€';
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshAllMetrics();
            
            // ìë™ ìƒˆë¡œê³ ì¹¨ ê¸°ë³¸ í™œì„±í™”
            toggleAutoRefresh();
        });
    </script>
</body>
</html>