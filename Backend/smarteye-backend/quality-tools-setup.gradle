// ğŸ“Š SmartEye Backend ì½”ë“œ í’ˆì§ˆ ë„êµ¬ ì„¤ì •
// build.gradleì— ì¶”ê°€í•  ë‚´ìš©

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.5'
    id 'io.spring.dependency-management' version '1.1.7'

    // ì½”ë“œ í’ˆì§ˆ ë„êµ¬ë“¤
    id 'jacoco'                                    // í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
    id 'org.sonarqube' version '4.4.1.3373'      // ì •ì  ë¶„ì„
    id 'com.github.spotbugs' version '6.0.7'     // ë²„ê·¸ ê°ì§€
    id 'checkstyle'                               // ì½”ë”© ìŠ¤íƒ€ì¼
    id 'pmd'                                      // ì½”ë“œ ë³µì¡ë„
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ Jacoco ì„¤ì • (í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

jacoco {
    toolVersion = "0.8.10"
}

jacocoTestReport {
    dependsOn test

    reports {
        xml.required = true
        html.required = true
        csv.required = false
    }

    finalizedBy jacocoTestCoverageVerification
}

jacocoTestCoverageVerification {
    dependsOn jacocoTestReport

    violationRules {
        rule {
            enabled = true
            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.80  // 80% ë¼ì¸ ì»¤ë²„ë¦¬ì§€ ê°•ì œ
            }
        }

        rule {
            enabled = true
            limit {
                counter = 'BRANCH'
                value = 'COVEREDRATIO'
                minimum = 0.70  // 70% ë¸Œëœì¹˜ ì»¤ë²„ë¦¬ì§€ ê°•ì œ
            }
        }

        rule {
            enabled = true
            element = 'CLASS'
            limit {
                counter = 'COMPLEXITY'
                value = 'TOTALCOUNT'
                maximum = 50    // í´ë˜ìŠ¤ë‹¹ ë³µì¡ë„ 50 ì´í•˜
            }
        }
    }

    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                '**/dto/**',           // DTO í´ë˜ìŠ¤ ì œì™¸
                '**/config/**',        // ì„¤ì • í´ë˜ìŠ¤ ì œì™¸
                '**/SmartEyeApplication.class'  // ë©”ì¸ í´ë˜ìŠ¤ ì œì™¸
            ])
        }))
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” SonarQube ì„¤ì • (ì¢…í•© ì •ì  ë¶„ì„)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

sonarqube {
    properties {
        property "sonar.projectKey", "smarteye-backend"
        property "sonar.projectName", "SmartEye Backend"
        property "sonar.projectVersion", project.version
        property "sonar.sourceEncoding", "UTF-8"

        // ì†ŒìŠ¤ ë””ë ‰í† ë¦¬
        property "sonar.sources", "src/main/java"
        property "sonar.tests", "src/test/java"

        // ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ê²½ë¡œ
        property "sonar.coverage.jacoco.xmlReportPaths", "build/reports/jacoco/test/jacocoTestReport.xml"

        // ì œì™¸ íŒ¨í„´
        property "sonar.exclusions", "**/dto/**, **/config/**, **/SmartEyeApplication.java"
        property "sonar.test.exclusions", "**/dto/**, **/config/**"

        // í’ˆì§ˆ ê²Œì´íŠ¸ ì„¤ì •
        property "sonar.qualitygate.wait", "true"

        // ì½”ë“œ ë³µì¡ë„ ì„ê³„ê°’
        property "sonar.complexity.file", "10"
        property "sonar.complexity.function", "10"

        // ê¸°ìˆ  ë¶€ì±„ ë¹„ìœ¨
        property "sonar.technicalDebt.ratingGrid", "0.05,0.1,0.2,0.5"
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ› SpotBugs ì„¤ì • (ë²„ê·¸ íŒ¨í„´ ê°ì§€)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

spotbugs {
    toolVersion = '4.8.3'
    effort = 'max'                    // ìµœëŒ€ ë…¸ë ¥ìœ¼ë¡œ ë¶„ì„
    reportLevel = 'medium'            // ì¤‘ê°„ ì´ìƒ ì‹¬ê°ë„ ë¦¬í¬íŠ¸
    showStackTraces = true
    showProgress = true
}

spotbugsMain {
    reports {
        html {
            required = true
            outputLocation = file("build/reports/spotbugs/main.html")
            stylesheet = 'fancy-hist.xsl'
        }
        xml {
            required = true
            outputLocation = file("build/reports/spotbugs/main.xml")
        }
    }
}

spotbugsTest {
    reports {
        html {
            required = true
            outputLocation = file("build/reports/spotbugs/test.html")
        }
        xml {
            required = true
            outputLocation = file("build/reports/spotbugs/test.xml")
        }
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ Checkstyle ì„¤ì • (ì½”ë”© ìŠ¤íƒ€ì¼ ê²€ì‚¬)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

checkstyle {
    toolVersion = '10.12.4'
    configFile = file("${rootDir}/config/checkstyle/checkstyle.xml")
    maxErrors = 0
    maxWarnings = 50
    ignoreFailures = false
}

checkstyleMain {
    reports {
        xml.required = true
        html.required = true
    }
}

checkstyleTest {
    reports {
        xml.required = true
        html.required = true
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š PMD ì„¤ì • (ì½”ë“œ ë³µì¡ë„ ë° í’ˆì§ˆ ë¶„ì„)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

pmd {
    toolVersion = '6.55.0'
    consoleOutput = true
    ignoreFailures = false
    rulePriority = 3
    ruleSetFiles = files("${rootDir}/config/pmd/pmd-rules.xml")
}

pmdMain {
    reports {
        xml.required = true
        html.required = true
    }
}

pmdTest {
    reports {
        xml.required = true
        html.required = true
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ ì‚¬ìš©ì ì •ì˜ íƒœìŠ¤í¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ì „ì²´ í’ˆì§ˆ ê²€ì‚¬ íƒœìŠ¤í¬
task qualityCheck {
    description = 'ëª¨ë“  ì½”ë“œ í’ˆì§ˆ ë„êµ¬ ì‹¤í–‰'
    group = 'verification'

    dependsOn check, jacocoTestReport, jacocoTestCoverageVerification
    dependsOn spotbugsMain, spotbugsTest
    dependsOn checkstyleMain, checkstyleTest
    dependsOn pmdMain, pmdTest

    doLast {
        println "ğŸ“Š ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ!"
        println "ğŸ“‹ ë¦¬í¬íŠ¸ ìœ„ì¹˜:"
        println "  - Jacoco: build/reports/jacoco/test/html/index.html"
        println "  - SpotBugs: build/reports/spotbugs/main.html"
        println "  - Checkstyle: build/reports/checkstyle/main.html"
        println "  - PMD: build/reports/pmd/main.html"
    }
}

// ë¹ ë¥¸ í’ˆì§ˆ ì²´í¬ (ì»¤ë²„ë¦¬ì§€ ì œì™¸)
task quickQualityCheck {
    description = 'ë¹ ë¥¸ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ì»¤ë²„ë¦¬ì§€ ì œì™¸)'
    group = 'verification'

    dependsOn spotbugsMain, checkstyleMain, pmdMain

    doLast {
        println "âš¡ ë¹ ë¥¸ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ!"
    }
}

// ì»¤ë²„ë¦¬ì§€ë§Œ ì²´í¬
task coverageCheck {
    description = 'í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë§Œ ê²€ì‚¬'
    group = 'verification'

    dependsOn test, jacocoTestReport, jacocoTestCoverageVerification

    doLast {
        println "ğŸ“Š ì»¤ë²„ë¦¬ì§€ ê²€ì‚¬ ì™„ë£Œ!"
    }
}

// CI/CDìš© í’ˆì§ˆ ê²Œì´íŠ¸
task qualityGate {
    description = 'CI/CD íŒŒì´í”„ë¼ì¸ìš© í’ˆì§ˆ ê²Œì´íŠ¸'
    group = 'verification'

    dependsOn test, qualityCheck

    doLast {
        // í’ˆì§ˆ ê¸°ì¤€ ì²´í¬
        def jacocoReport = file("build/reports/jacoco/test/jacocoTestReport.xml")
        if (jacocoReport.exists()) {
            def coverage = extractCoverageFromJacocoReport(jacocoReport)
            if (coverage < 80) {
                throw new GradleException("âŒ ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€ ë¯¸ë‹¬: ${coverage}% < 80%")
            }
            println "âœ… ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€ í†µê³¼: ${coverage}%"
        }

        println "ğŸ‰ ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼!"
    }
}

// í—¬í¼ í•¨ìˆ˜: Jacoco ë¦¬í¬íŠ¸ì—ì„œ ì»¤ë²„ë¦¬ì§€ ì¶”ì¶œ
def extractCoverageFromJacocoReport(File reportFile) {
    def report = new XmlSlurper().parse(reportFile)
    def covered = report.counter.find { it.@type == 'LINE' }.@covered.toInteger()
    def missed = report.counter.find { it.@type == 'LINE' }.@missed.toInteger()
    def total = covered + missed
    return total > 0 ? (covered * 100 / total) : 0
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ ì˜ì¡´ì„± ì¶”ê°€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

dependencies {
    // ê¸°ì¡´ ì˜ì¡´ì„±ë“¤...

    // ì•„í‚¤í…ì²˜ í…ŒìŠ¤íŠ¸
    testImplementation 'com.tngtech.archunit:archunit-junit5:1.2.1'

    // ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    testImplementation 'org.openjdk.jmh:jmh-core:1.37'
    testAnnotationProcessor 'org.openjdk.jmh:jmh-generator-annprocess:1.37'

    // í’ˆì§ˆ ë„êµ¬ í”ŒëŸ¬ê·¸ì¸ë“¤
    spotbugsPlugins 'com.h3xstream.findsecbugs:findsecbugs-plugin:1.12.0'
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“… ì£¼ê¸°ì  ì‹¤í–‰ ì„¤ì • (CI/CD í†µí•©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// GitHub Actions ì›Œí¬í”Œë¡œìš° ì˜ˆì‹œëŠ” ë³„ë„ íŒŒì¼ë¡œ ìƒì„±